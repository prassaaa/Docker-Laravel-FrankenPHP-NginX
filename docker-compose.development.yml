x-php: &php
    build:
        context: docker/php
        dockerfile: php.dockerfile
        args:
            ENVIRONMENT: development
    restart: unless-stopped
    working_dir: /srv
    volumes:
        - .:/srv
        - ~/.composer:/home/composer/.cache/composer
        - ~/.composer/auth.json:/config/composer/auth.json
        - ./vendor:/srv/vendor:delegated

services:
    nginx:
        image: nginx:1.27-alpine
        restart: unless-stopped
        ports:
            - "80:80"
            - "443:443"
        volumes:
            - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
            - ./docker/nginx/conf.d/app.conf:/etc/nginx/templates/app.conf.template
            - ./docker/nginx/ssl:/etc/nginx/ssl:ro
        depends_on:
            - php

    node:
        image: node:22-alpine
        user: node
        working_dir: /srv
        entrypoint: ["tail", "-f", "/dev/null"]
        volumes:
            - .:/srv
            - ./node_modules:/srv/node_modules

    php:
        <<: *php
        environment:
            - SERVER_NAME=:8080
            - APP_ENV=local
            - FRANKENPHP_WORKERS=auto
            - FRANKENPHP_MAX_REQUESTS=500
            - AUTO_MIGRATE=false

    scheduler:
        <<: *php
        command: php artisan schedule:work

    queue:
        <<: *php
        command: php artisan queue:work --timeout=0