x-php: &php
    build:
        context: docker/php
        dockerfile: php.dockerfile
        args:
            ENVIRONMENT: development
    restart: unless-stopped
    working_dir: /srv
    volumes:
        - .:/srv
        - ~/.composer:/home/composer/.cache/composer
        - ~/.composer/auth.json:/config/composer/auth.json
        - ./vendor:/srv/vendor:delegated
    dns:
        - 8.8.8.8
        - 8.8.4.4
    dns_opt:
        - ndots:1
        - timeout:3
        - attempts:2

services:
    nginx:
        build:
            context: docker/nginx
            dockerfile: nginx.dockerfile
        restart: unless-stopped
        ports:
            - "80:80"
            - "443:443"
        deploy:
            resources:
                limits:
                    cpus: '1'
                    memory: 512M
                reservations:
                    cpus: '0.25'
                    memory: 128M
        security_opt:
            - no-new-privileges:true
        cap_drop:
            - ALL
        cap_add:
            - NET_BIND_SERVICE
            - CHOWN
            - SETUID
            - SETGID
        read_only: true
        tmpfs:
            - /tmp
            - /var/run
            - /var/cache/nginx
        volumes:
            - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
            - ./docker/nginx/conf.d/app.conf:/etc/nginx/templates/app.conf.template
            - ./docker/nginx/ssl:/etc/nginx/ssl:ro
        depends_on:
            - php

    node:
        image: node:22-alpine
        user: node
        working_dir: /srv
        entrypoint: ["tail", "-f", "/dev/null"]
        volumes:
            - .:/srv
            - ./node_modules:/srv/node_modules
        deploy:
            resources:
                limits:
                    cpus: '1'
                    memory: 1G
                reservations:
                    cpus: '0.25'
                    memory: 256M

    php:
        <<: *php
        environment:
            - SERVER_NAME=:8080
            - APP_ENV=local
            - FRANKENPHP_WORKERS=auto
            - FRANKENPHP_MAX_REQUESTS=500
            - AUTO_MIGRATE=false
        deploy:
            resources:
                limits:
                    cpus: '2'
                    memory: 1G
                reservations:
                    cpus: '0.5'
                    memory: 256M
        security_opt:
            - no-new-privileges:true
        cap_drop:
            - ALL
        cap_add:
            - CHOWN
            - SETUID
            - SETGID
            - DAC_OVERRIDE

    scheduler:
        <<: *php
        command: php artisan schedule:work
        deploy:
            resources:
                limits:
                    cpus: '0.5'
                    memory: 256M
                reservations:
                    cpus: '0.1'
                    memory: 128M

    queue:
        <<: *php
        command: php artisan queue:work --timeout=0
        deploy:
            resources:
                limits:
                    cpus: '1'
                    memory: 512M
                reservations:
                    cpus: '0.25'
                    memory: 256M

networks:
    default:
        driver: bridge
        driver_opts:
            com.docker.network.bridge.name: laravel_dev
            com.docker.network.bridge.enable_icc: "true"
            com.docker.network.bridge.enable_ip_masquerade: "true"
        ipam:
            driver: default
            config:
                - subnet: 172.20.0.0/16
                  gateway: 172.20.0.1
