# SSL/TLS Optimization Configuration

# Modern SSL configuration
ssl_protocols TLSv1.2 TLSv1.3;

# Optimized cipher suites for performance and security
# TLS 1.3 ciphers (automatically used when TLS 1.3 is negotiated)
ssl_conf_command Ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256;

# TLS 1.2 ciphers
ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305;

# Prefer server ciphers
ssl_prefer_server_ciphers on;

# SSL session cache optimization
ssl_session_cache shared:SSL:50m;
ssl_session_timeout 1d;
ssl_session_tickets off;

# OCSP Stapling
ssl_stapling on;
ssl_stapling_verify on;
ssl_trusted_certificate /etc/nginx/ssl/cert.pem;

# DNS resolvers for OCSP
resolver 8.8.8.8 8.8.4.4 1.1.1.1 1.0.0.1 valid=300s;
resolver_timeout 5s;

# DH parameters for perfect forward secrecy
ssl_dhparam /etc/nginx/ssl/dhparam.pem;

# SSL buffer size (optimized for performance)
ssl_buffer_size 4k;

# Enable 0-RTT for TLS 1.3
ssl_early_data on;

# HTTP/2 and HTTP/3 configuration
http2_max_field_size 16k;
http2_max_header_size 32k;
http2_push_preload on;

# Security headers specific to SSL
add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

# Certificate transparency
add_header Expect-CT "max-age=86400, enforce" always;

# HTTP/2 Server Push for critical resources
location = /index.html {
    http2_push /css/app.css;
    http2_push /js/app.js;
    http2_push /css/fonts.css;
    add_header Link "</css/app.css>; rel=preload; as=style" always;
    add_header Link "</js/app.js>; rel=preload; as=script" always;
}

# Optimize SSL for API endpoints
location /api/ {
    # Disable 0-RTT for API endpoints (security)
    ssl_early_data off;
    
    # Add security headers
    add_header X-API-Version "1.0" always;
    add_header Cache-Control "no-store, no-cache, must-revalidate" always;
    
    try_files $uri @frankenphp;
}

# SSL session resumption test endpoint
location = /ssl-test {
    add_header X-SSL-Protocol $ssl_protocol always;
    add_header X-SSL-Cipher $ssl_cipher always;
    add_header X-SSL-Session-ID $ssl_session_id always;
    add_header X-SSL-Session-Reused $ssl_session_reused always;
    return 200 "SSL Test OK\n";
}