# Static Asset Caching Configuration

# Cache control map based on file type
map $sent_http_content_type $cache_control {
    default                         "public, max-age=3600";
    
    # HTML - shorter cache, must revalidate
    ~*text/html                     "public, max-age=300, must-revalidate";
    
    # CSS/JS - versioned assets, long cache
    ~*text/css                      "public, max-age=31536000, immutable";
    ~*application/javascript        "public, max-age=31536000, immutable";
    
    # Images - long cache
    ~*image/                        "public, max-age=31536000, immutable";
    
    # Fonts - very long cache
    ~*font/                         "public, max-age=31536000, immutable";
    ~*application/vnd.ms-fontobject "public, max-age=31536000, immutable";
    ~*application/x-font-ttf        "public, max-age=31536000, immutable";
    ~*application/x-font-opentype   "public, max-age=31536000, immutable";
    ~*application/x-font-woff       "public, max-age=31536000, immutable";
    
    # Media files
    ~*video/                        "public, max-age=31536000, immutable";
    ~*audio/                        "public, max-age=31536000, immutable";
    
    # Documents
    ~*application/pdf               "public, max-age=86400";
    ~*application/msword            "public, max-age=86400";
}

# ETag configuration based on file type
map $uri $etag_suffix {
    default                         "";
    ~*\.(css|js)$                  "$date_gmt";
    ~*\.(jpg|jpeg|png|gif|ico)$    "static";
    ~*\.(woff|woff2|ttf|eot|svg)$  "static";
}

# Expires map for legacy support
map $sent_http_content_type $expires {
    default                         1h;
    ~*text/html                     5m;
    ~*text/css                      1y;
    ~*application/javascript        1y;
    ~*image/                        1y;
    ~*font/                         1y;
    ~*application/vnd.ms-fontobject 1y;
    ~*application/x-font            1y;
    ~*video/                        1y;
    ~*audio/                        1y;
}

# Static file location blocks
location ~* \.(jpg|jpeg|png|gif|ico|webp|avif)$ {
    add_header Cache-Control $cache_control;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Vary "Accept-Encoding";
    
    # Enable serving of webp images if available
    try_files $uri$webp_suffix $uri =404;
    
    # Expire and ETag
    expires $expires;
    etag on;
    
    # Don't log access to assets
    access_log off;
}

location ~* \.(css|js)$ {
    add_header Cache-Control $cache_control;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Vary "Accept-Encoding";
    
    # Enable source maps in development
    add_header X-SourceMap "/build/$uri.map";
    
    # Expire and ETag
    expires $expires;
    etag on;
    
    # Compression already handled globally
    access_log off;
}

location ~* \.(woff|woff2|ttf|eot|otf)$ {
    add_header Cache-Control $cache_control;
    add_header X-Content-Type-Options "nosniff" always;
    
    # CORS for fonts
    add_header Access-Control-Allow-Origin "*";
    
    expires $expires;
    etag on;
    access_log off;
}

location ~* \.(svg)$ {
    add_header Cache-Control $cache_control;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Content-Security-Policy "script-src 'none'";
    
    expires $expires;
    etag on;
    access_log off;
}

# Laravel mix/vite versioned assets
location ~* \.(css|js)\?id=[0-9a-f]+ {
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header X-Content-Type-Options "nosniff" always;
    expires 1y;
    etag off;
    access_log off;
}

# Service worker
location = /sw.js {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Service-Worker-Allowed "/";
    expires off;
    etag off;
}

# Manifest files
location ~* \.(webmanifest|json)$ {
    add_header Cache-Control "public, max-age=604800";
    add_header X-Content-Type-Options "nosniff" always;
    expires 7d;
    etag on;
}